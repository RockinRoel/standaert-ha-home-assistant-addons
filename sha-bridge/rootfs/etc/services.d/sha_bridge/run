#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the example service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

declare serial_port debug mqtt

serial_port=$(bashio::config 'serial_port')
if [ "${serial_port}" != "null" ]; then
  export SHA_SERIAL_DEVICE="${serial_port}"
fi

debug=$(bashio::config 'debug')
if [ "${debug}" != "null" ]; then
  export SHA_DEBUG="${debug}"
fi

mqtt=$(bashio::config 'mqtt')
if [ "${mqtt}" == "true" ]; then
  declare mqtt_host mqtt_ssl mqtt_port mqtt_scheme
  mqtt_host="$(bashio::services mqtt 'host')"
  mqtt_ssl="$(bashio::services mqtt 'ssl')"
  if [ "${mqtt_ssl}" = "true" ]; then
    mqtt_scheme="mqtts"
  else
    mqtt_scheme="mqtt"
  fi
  mqtt_port="$(bashio::services mqtt 'port')"
  export SHA_MQTT_URL="${mqtt_scheme}://${mqtt_host}:${mqtt_port}?client_id=standaert_ha"
  export SHA_MQTT_USER="$(bashio::services mqtt 'username')"
  export SHA_MQTT_PASSWORD="$(bashio::services mqtt 'password')"
fi

echo "*** ENV ***"
env
echo "***********"

exec /usr/bin/sha_bridge
